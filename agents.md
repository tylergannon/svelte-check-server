# svelte-check-server - Agent Research Notes

## Purpose

This tool speeds up `svelte-check` in SvelteKit projects by running a persistent `svelte-check --watch` process and caching results. Instead of running a full check each time (which can take 5-15+ seconds), clients can get instant cached results.

---

## Legacy TypeScript Daemon Behavior

The original `svelte-check-daemon` (in `legacy-software/`) had these features:

### What It Watched

1. **Git HEAD** (`.git/HEAD`)
   - On any change → **restart svelte-check**
   - Catches branch switches

2. **Route files** (`+*.ts` pattern in watched directories)
   - On any change → **run `svelte-kit sync`** (debounced 250ms)
   - Does NOT restart svelte-check
   - Uses `WATCH_DIRS` (non-recursive) and `WATCH_DIRS_RECURSIVE` (defaults to `.`) env vars

3. **"Big changes" directory** (optional, via `SVELTE_CHECK_WATCH_BIG_CHANGES` env)
   - Tracks all files in directory
   - On **file deletion only** → **restart svelte-check**
   - File creation/modification does NOT trigger restart

4. **SIGHUP signal**
   - On SIGHUP → **restart svelte-check**
   - Allows manual restart trigger

### What It Did NOT Watch

- Package lock files (package-lock.json, bun.lock, etc.)
- svelte.config.js / vite.config.ts
- Branch ref files (commits/pulls within same branch)
- Normal file modifications (handled by svelte-check --watch itself)

---

## Deep Dive: How svelte-check --watch Works

### Architecture

From analyzing the source code:

1. **svelte-check** (`packages/svelte-check/src/index.ts`) uses:
   - `chokidar` for file watching
   - `SvelteCheck` class from `svelte-language-server` for diagnostics
   - A `DiagnosticsWatcher` class that manages file updates

2. **SvelteCheck** (`packages/language-server/src/svelte-check.ts`):
   - Creates a `DocumentManager` to track open documents
   - Uses `LSAndTSDocResolver` for TypeScript integration
   - Registers plugins: `SveltePlugin`, `CSSPlugin`, `TypeScriptPlugin`

3. **LSAndTSDocResolver** (`packages/language-server/src/plugins/typescript/LSAndTSDocResolver.ts`):
   - Manages TypeScript language service instances
   - Handles document snapshots
   - Watches for package.json changes
   - Has `onProjectReloaded` callback for when TS service restarts

4. **LanguageServiceContainer** (`packages/language-server/src/plugins/typescript/service.ts`):
   - Creates and manages TypeScript `LanguageService` instances
   - Watches tsconfig files and reloads on changes
   - Manages module resolution cache
   - Tracks "dirty" state for incremental updates

### What svelte-check --watch handles automatically:

1. **File content changes** - Updates document snapshots via `updateDocument()`
2. **New file creation** - Adds to watcher, schedules diagnostics
3. **File deletion** - Removes document, schedules diagnostics (but can crash - see issue #2773)
4. **tsconfig.json changes** - Watches config file, disposes and recreates service
5. **Extended tsconfig changes** - Also watches files referenced via `extends`
6. **package.json changes in node_modules** - Updates module resolution

### What svelte-check --watch does NOT handle:

1. **Git operations** - No awareness of version control
2. **Branch switches** - TS service has cached file contents from previous branch
3. **Bulk file changes** - After `git pull`/`merge`/`rebase`, many files may have changed but watcher only sees them one by one
4. **Module resolution cache staleness** - After branch switch, modules may resolve differently
5. **Generated types staleness** - `.svelte-kit/types/` generated by `svelte-kit sync`

---

## When TypeScript Language Service Gets Stale

From the TypeScript wiki and source analysis:

### TypeScript Project System

The TS language service maintains:
- **Configured Projects** - Defined by tsconfig.json
- **Inferred Projects** - For loose files without tsconfig
- **Module Resolution Cache** - Remembers where modules resolved to
- **Program** - The compiled representation of all files

### Staleness Scenarios

1. **Module Resolution Cache**
   - If a new package is installed, old resolution "not found" may be cached
   - If package.json changes, auto-imports may be wrong
   - Solution: `invalidateModuleCache()` or full restart

2. **tsconfig.json Changes**
   - TS watches tsconfig and reloads automatically in `svelte-check --watch`
   - But external tools changing tsconfig (e.g., `svelte-kit sync` updating includes) may not trigger

3. **File System Race Conditions**
   - Git operations can cause rapid create/delete sequences
   - `chokidar` may see intermediate states
   - Can cause crashes (issue #2773) or stale state

4. **Generated Files**
   - SvelteKit generates types in `.svelte-kit/types/`
   - `svelte-kit sync` regenerates these for route files
   - If route files (`+page.ts`, `+layout.ts`, `+server.ts`) change, types need regeneration
   - svelte-check won't know to run `svelte-kit sync`

---

## Specific Events That Need Handling

### MUST Restart svelte-check:

| Event | Why | Detection |
|-------|-----|-----------|
| Git branch switch | Files may have completely different contents; module resolution may differ | Watch `.git/HEAD` |
| Git pull/merge/rebase | Many files change atomically; resolution cache stale | Watch `.git/refs/heads/<branch>` |
| npm/bun install | node_modules changed; new modules or updated versions | Watch `package-lock.json`, `bun.lock`, `node_modules/.package-lock.json` |
| tsconfig.json significant changes | Compiler options change | Already handled by svelte-check, but verify |
| svelte.config.js changes | Compiler settings change | Need to add watch |

### SHOULD Run svelte-kit sync:

| Event | Why | Detection |
|-------|-----|-----------|
| Route file created | `+page.ts`, `+layout.ts`, `+server.ts`, `+page.server.ts`, `+layout.server.ts` | Watch for `+*.ts` in routes |
| Route file deleted | Types reference deleted file | Watch for `+*.ts` deletion |
| Route directory created/renamed | Changes route parameters, types | Watch `src/routes/**` |

### MAY Need Restart (Be Conservative):

| Event | Why | Detection |
|-------|-----|-----------|
| vite.config.ts changes | May affect module resolution | Watch config |
| .env file changes | May affect build-time constants | Watch `.env*` |
| Large number of file changes rapidly | TS service may be confused | Heuristic: >10 files in 1 second |

---

## Known Issues from GitHub

### Issue #2773: svelte-check --watch crashes on file deletion
- When bundler (esbuild, vite) removes files from output directory
- ENOENT error trying to read deleted file
- Workaround: Wrapper script that restarts on crash

### Issue #965: TS/JS file watchers watch too many files
- svelte-check may watch more than needed
- `--ignore` option doesn't work with `--tsconfig`

### Generated Types Errors
- Error 2307: "Cannot find module './$types'"
- Error 2694: "Namespace '$types' has no exported member"
- svelte-check adds helpful message: "try running 'npm run dev' or 'npm run build'"

---

## Implementation Recommendations

### Current Implementation (Go server):
- Watches `.git/HEAD` for branch switches ✅
- Watches `.git/refs/heads/<branch>` for commits ✅
- Kills entire process group on shutdown ✅
- Does NOT restart on normal file changes (correct!) ✅
- File watcher sets up directories but doesn't trigger restarts (only git does)

### Comparison: Current vs Legacy

| Feature | Legacy (TS) | Current (Go) |
|---------|-------------|--------------|
| Git HEAD watch | ✅ restart | ✅ restart |
| Git branch ref watch | ❌ | ✅ restart |
| Route file watch | ✅ svelte-kit sync | ❌ not implemented |
| Big changes (deletion) | ✅ restart (opt-in) | ❌ not implemented |
| SIGHUP restart | ✅ | ❌ not implemented |
| Lock file watch | ❌ | ❌ |
| Config file watch | ❌ | ❌ |

### Recommended Additions (Priority Order):

1. **Run `svelte-kit sync` on route file changes** (HIGH)
   - Watch for `+page.ts`, `+layout.ts`, `+server.ts`, `+page.server.ts`, `+layout.server.ts`
   - On create/delete/rename → run `svelte-kit sync` (debounced)
   - This is critical for SvelteKit type generation
   - Legacy daemon did this and it's important for correctness

2. **Add SIGHUP handler** (MEDIUM)
   - On SIGHUP → restart svelte-check
   - Allows manual restart without killing server

3. **Add crash recovery** (MEDIUM)
   - If svelte-check process exits unexpectedly, restart it
   - Log the crash for debugging

4. **Watch for package manager lock files** (LOW - nice to have)
   ```
   package-lock.json
   bun.lock
   pnpm-lock.yaml
   yarn.lock
   ```
   → Restart svelte-check (module resolution may change)

5. **Watch for config file changes** (LOW - nice to have)
   ```
   svelte.config.js
   vite.config.ts
   vite.config.js
   ```
   → Restart svelte-check

6. **Add health endpoint** (LOW - nice to have)
   - `/health` endpoint to verify svelte-check is responsive

### Philosophy: Err on the Side of Correctness

When in doubt, **restart svelte-check**. 

- A false restart costs a few seconds (svelte-check startup time)
- Stale/incorrect diagnostics can waste hours of developer time debugging phantom errors
- Missing real errors can cause production bugs

The cost of false positives (unnecessary restarts) is much lower than false negatives (stale state).

---

## References

- [svelte-check source](https://github.com/sveltejs/language-tools/tree/master/packages/svelte-check)
- [svelte-language-server source](https://github.com/sveltejs/language-tools/tree/master/packages/language-server)
- [TypeScript tsserver wiki](https://github.com/microsoft/TypeScript/wiki/Standalone-Server-(tsserver))
- [Issue #2773: crash on file deletion](https://github.com/sveltejs/language-tools/issues/2773)
- [SvelteKit svelte-kit sync docs](https://svelte.dev/docs/kit/cli#svelte-kit-sync)
- [SvelteKit generated types](https://svelte.dev/docs/kit/types#Generated-types)
