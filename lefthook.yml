pre-commit:
  parallel: true
  jobs:
    - name: go-version-check
      glob: "*.go"
      run: |
        MOD_VERSION=$(grep '^go ' go.mod | awk '{print $2}')
        CURRENT_VERSION=$(go version | awk '{print $3}' | sed 's/^go//')
        if [ "$(printf '%s\n' "$MOD_VERSION" "$CURRENT_VERSION" | sort -V | tail -1)" != "$MOD_VERSION" ]; then
          echo "Error: Go version $CURRENT_VERSION is newer than go.mod version $MOD_VERSION"
          exit 1
        fi

    - name: goimports
      glob: "*.go"
      run: go run golang.org/x/tools/cmd/goimports@latest -w {staged_files}
      stage_fixed: true

    - name: modernize
      glob: "*.go"
      run: go run golang.org/x/tools/gopls/internal/analysis/modernize/cmd/modernize@latest -fix -test ./...
      stage_fixed: true

    - name: golangci-lint
      glob: "*.go"
      run: go run github.com/golangci/golangci-lint/v2/cmd/golangci-lint@latest run

    - name: test
      glob: "*.go"
      run: go test -short ./...
